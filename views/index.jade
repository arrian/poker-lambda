extends layout

block content
  h1 Poker
  p id !{id}

  div#app 

  script(src="https://unpkg.com/vue@3/dist/vue.global.js")
  script.
    console.log('loaded');
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          game: null,
          gameString: null,
          message: 'Hello Vue!',
          inputs: {}
        }
      },
      mounted() {
        this.load();
      },
      methods: {
        async load() {
          const result = await fetch('/status').then(response => response.json());
          this.game = result;
          this.gameString = JSON.stringify(result, null, 4);
          this.inputs = {};
          this.game.players.forEach(player => this.inputs[player.id] = this.game.round.bets[player.id] || 0);
          return result;
        },
        cardUrl(card) {
          const value = this.game.ValueName[card.value];
          const suit = this.game.SuitName[card.suit];
          return `background-image: url('https://raw.githubusercontent.com/arrian/cards-svg/master/svg/${value}-${suit}.svg')`;
        },
        cardOverlap(index) {
          return `grid-area: 1 / ${index + 1} / span 1 / span 5`;
        },
        async sendAction(player, action, data) {
          const body = {
            player,
            action,
            data: data || {}
          };

          await fetch('/action', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(body)
          });

          await this.load();
        }
      },
      template: `
      <div v-if="game && game.round">
      <div class="table">
        <h2>Table</h2>
        <div>{{ game.round.progress }}</div>
        <button @click="sendAction(null, 'ROUND_START')">Start Round</button>
        <button @click="sendAction(null, 'ROUND_END')">End Round</button>
        <div>Pot \${{game.pot}}</div>
        <div>Bet \${{game.bet}}</div>
        <div class="actions">
          <div class="action" v-if="game && game.round" v-for="log in game.round.log">{{ log?.player?.name }} {{ log?.action?.type }} {{ log?.action?.data?.value }}</div>
        </div>
        <div v-if="game && game.round && game.round.actingPlayer">Awaiting {{game.round.actingPlayer.name}}</div>
        <div class="deck">
          <div v-if="game && game.round && game.round.deck" v-for="(card, index) in game.round.deck.cards" class="card" :style="cardOverlap(index)">
            <div class="front" :style="cardUrl(card)"></div>
            <div class="back"></div>
          </div>
        </div>
        <div>
          <div v-if="game && game.round && game.round.communityCards" v-for="(card, index) in game.round.communityCards.cards" class="card" :style="cardOverlap(index)">
            <div class="front" :style="cardUrl(card)"></div>
            <div class="back"></div>
          </div>
        </div>
      </div>
      <div class="player" v-if="game && game.players" v-for="player in game.players">
        <h2>{{ player.name }}</h2>
        <div>\${{ player.worth }}</div>
        <div>Action {{game.round.actions[player.id]}}</div>
        <div>Bet {{game.round.bets[player.id]}}</div>
        <div>
          <div v-for="(card, index) in player.hand.cards" class="card" :style="cardOverlap(index)">
            <div class="front" :style="cardUrl(card)"></div>
            <div class="back"></div>
          </div>
        </div>
        <input type="number" v-model="inputs[player.id]">
        <button @click="sendAction(player.id, 'FOLD')">Fold</button>
        <button @click="sendAction(player.id, 'CHECK')">Check</button>
        <button @click="sendAction(player.id, 'CALL', { value: +inputs[player.id] })">Call</button>
        <button @click="sendAction(player.id, 'ALL_IN', { value: +inputs[player.id] })">All In</button>
        <button @click="sendAction(player.id, 'BET', { value: +inputs[player.id] })">Bet</button>
        <button @click="sendAction(player.id, 'RAISE', { value: +inputs[player.id] })">Raise</button>
      </div>
      <details>
      <summary>Json</summary>
      <pre>{{gameString}}</pre>
      </details>
      </div>
      `
    }).mount('#app');
